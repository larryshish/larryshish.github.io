---
layout: post
title: 你应该使用微服务吗
---
微服务是一种新的架构风格，在软件开发中存在很多架构风格，例如通常见于Linux、Unix上的数据流架构风格，具有Web页面的事件驱动架构风格，大型网络，电商常用的分布式架构风格等等，很多时候同一应用软件里面可能存在不同的架构风格。

在一种架构风格的指导下，我们可以设计出特定的架构，那么我们应该使用什么样的架构？这应该和特定应用类型以及特定的业务场景相对应的。

本文想探讨一下微服务的概念，其对软件开发带来的益处，应该在什么场景下使用微服务，以及如果应用微服务的话，应该如何怎么来做。

首先我们来看一些和微服务相关的概念：
## 概念
### 单体（Monolith）
单体应用（Monolith Application）（也有人翻译成**整体应用**，其实我觉得**整体应用**更贴切一些，可是**整体**这个词太普通，在上下文中使用有时间大家不会想到其指代monolith） 是指将应用程序所有的功能都放在一起，形成一个单元。软件设计，开发，部署都是以这个单元为单位的。在java中通常是EAR包，WAR包，Jar包等，在Python中通常是一个整体的目录结构。

单体应用是大家非常熟知软件开发模式，J2EE中与之对应通常有三层架构模式：表示层，应用层，数据访问层。

当部署某单体应用的时候，我们必须要构建和部署整个应用，如果是比较大的应用的话，这会很复杂、有风险、耗时，并且需要与众多的开发人员协调从而导致很长的开发，测试周期，有的时候因为应用很大，编译，重启要花费很长的时间。我还记得之前我做的一个保险应用重启一次大概需要十几分钟。

下面是我从网上找的一篇漫画，虽然是漫画，当也是现实。
![](http://jbcdn2.b0.upaiyun.com/2012/09/code-is-Compiling-Chinese.jpg)


### 微服务（Microservice）
微服务的与单体相反，在微服务架构中，应用会被拆分成一个个的独立的，具有不同业务功能独立单元，这些服务可以独立开发，部署和运行。

使用微服务的应用就可以对每个服务进行独立部署和扩展；一个服务可以被部署为多个实例，而不同的服务也可以托管在同一台服务器上。

### System of Record
Systems of Records没有看到过正式的翻译，无论是公司内部或者在和客户沟通的时候，我们一般都是直接使用System of Record这个词。它是指那些传统的企业应用系统，一般主要目的是记录业务信息，保证这些信息的完整性，正确性以及一致性。下面这些是System of Record系统的一些例子：

* 客户关系管理系统 (CRM)
* 人力资源管理系统 (HRM)
* ERP系统 (ERP)
* 财务系统（Finance）
一般来说，System of Record基本上是单体应用。

### System of Engagement
Systems of engagement 一般指那些去中心化的，鼓励用户互动的应用系统。下面是Systems of engagements的一些例子：

* email
* Wiki
* 社交网络（tweet，微信，Facebook）
* 机器学习，人工智能系统（IBM Waston）

System of Records和System of Enagement分类的提出是Geoffrey Moore，他有一篇有名的文章[System of Engagement and Future of Enterprise IT](http://www.aiim.org/~/media/Files/AIIM%20White%20Papers/Systems-of-Engagement-Future-of-Enterprise-IT.ashx)，在这篇文章中指出，System of Enagement是以后Enterprise非常重要的一类应用，因为通过Engagement（包括和客户以及内部员工），通过互动和协作，可以创造高效的生产率。

##为什么我们需要微服务

### 快速交付的要求         

快速交付有两个层面，一是可以利用已有的service来快速构建新的应用
二是微服务是独立的，比较小的功能。程序员可以在一个sprint里面完成某个服务的功能，这对于那些大的单体应用来说在两周之内完成某些功能的交付是比较困难的。

### 更高层次的编程要求          

这里的更高层次是指从**做什么**的层次，而不是**这么做**这个低层次。 现在有句流行的话叫**供给侧改革**，供给侧改革的意思是为了不产能过剩，不能自己埋头生产，而是根据客户的需要来生产。软件产品也是一样，不能自己埋头coding，而是根据客户的需求来编写相应的代码，那么谁最了解客户的需求？当然是客户自己。如果我们提供各种微服务给客户，客户只需要根据一定的格式编排这些服务，就可以快速的搭建出满足业务需求的应用，那会极大的促进业务的发展的。

### 应用横向扩展（scale out）的要求    

在单体应用，有的应用是无法scale out的，只能scale up。即使可以横向扩展的话，也会造成一些浪费。例如我们有一个websphere的服务器，想要做扩展的话，会创建一个websphere的集群，集群中的每一个服务器都会有Web 容器、嵌入式 HTTP 服务器，消息引擎等等，无论这些组件是否需要扩展。这会造成资源的浪费。
单体式应用在不同模块发生资源冲突时，扩展将会非常困难。一个需要很多CPU资源的模块和一个需要很多内存模块在部署的时候资源需求是不一样的，但是因为这些模块部署在一起，因此我们不得不在硬件选择上做一个妥协。
但是如果是基于微服务的话，我们完全可以把不同的服务根据资源的需求部署到不同的硬件中去。

### 系统的健壮性要求               

单体式应用所有模块都运行在一个进程中，任何一个模块中的一个bug，比如内存泄露，将会有可能弄垮整个进程。除此之外，因为所有应用实例都是唯一的，这个bug将会影响到整个应用的可靠性

微服务把不同的服务分开部署，这些服务相互之前资源的占用是独立的，不会因为一个服务的bug而影响其他服务。

### 混合架构的需要   

以前我是非常反对在同一个项目里面引入不同的语言栈的，因为这会对开发人员有较高的要求，维护起来也很困难。但是随着开源项目的蓬勃发展，许多公共模块都有对应的开源项目的很好实现。有的时候这种实现不同的语言实现的，使用的不同的架构。这在之前的单体架构里面是很难引入的，但是如果采用微服务架构，这些问题就不复存在了。



## 构建微服务面临的挑战
###架构复杂性
一般来说，一个基于微服务架构构建的系统通常要包含数十到上百的服务，Netflex是微服务的早先采用者，他现在有大约600个服务。这么多服务要想很好的一起配合运行的话，在架构上有很多店需要考虑到，例如：

* 服务的注册和发现
* 服务的认证和授权
* 依赖服务故障处理
* 服务是同步还是异步
* 缓存
* 负载均衡
* 服务监控
* 服务扩展
* 服务升级
* 向后兼容

虽然现在有框架来处理这些复杂性，但是这些复杂性还是会带来很多开销的，下面我从几个点具体讲一些挑战
###分布式带来的挑战
微服务都是分布式调用的，分布式系统有固有的复杂性。
#### 通信
对于单体架构的应用来说，组件调用其他的组件一般是直接的方法调用。但是在微服务架构中，由于不同的服务运行在不同的进程之中，所以开发者需要在RPC或者消息传递之间选择并完成进程间通讯机制。基于RPC或者消息调用的话，必须写代码来处理消息传递中系统不一致的问题。现有的框架只能处理部分问题，还是需要自己写很多胶水程序来弥补不同的scenario的要求的，相对于单体应用中通过语言层级的方法或者进程调用，微服务下这种技术显得更复杂一些。

###数据库&事务
这是微服务中现在没有很好解决方案的一个挑战。业务系统中同时给多个业务主体更新字段很正常。对于单体式应用来说，只要放在一个事务（transaction）里面就可以了。但是在微服务架构应用中，需要更新不同服务所使用的不同的数据库。分布式事务可能是一种选择，但是这需要中间件的支持，而且分布式事务也会带来很多问题。最终你不得不使用一个最终一致性的方法，从而对开发者提出了更高的要求和挑战。

### 需要Devops团队
由于微服务的服务众多，采用之前的开发，测试，上线，运维流程是不可行的。只有采用devops，让更多的部署自动化，才能满足发布和运维的需求。

### 服务依赖
由于服务众多，需要从架构层面来分析服务的依赖，从工具层面解决服务的依赖。

### 监控和日志
微服务中监控非常重要。要想解决问题，必须对数据日志进行分析，而这些日志很可能横跨多台服务器的多项服务。这些众多的服务无法由人员来手工负责，必须采用自动化的监控和日志分析工具。

### 测试
测试一个基于微服务架构的应用也是很复杂的任务。因为服务之间有很多依赖，如何在测试中隔离依赖，这也是一个很大的挑战。


## 构建微服务的路径

### 拆分微服务
决定如何将系统拆分为一组服务在很大程度上来讲是一门艺术，不过还是一些基本方法的。例如我们可以根据领域（domain）来划分微服务，infoq上有一本很好的将领域驱动设计的[书](http://www.infoq.com/cn/minibooks/domain-driven-design-quickly-new)。
### 确定服务契约
协调各种服务，意味着服务之间的契约更多，我们需要小心谨慎的提供我们的服务接口，这些接口一旦提供出去，对它们的修改就会变得很困难。在这方面，有一些最佳实践的，例如加上服务的版本号，分离核心服务和扩展服务等。

### 确定流程
在拆分好服务之后，我们还需要建设一个服务网关，服务网关的作用是针对不同的客户端，提供一些聚合的服务。根据以往的经验，如果让客户直接来调用这些服务的话，会构建成一个复杂的，性能极其低下的系统。服务网关可以隔离复杂性，有利于修改，提高性能。


## 一些开发框架
* [KumuluzEE](https://ee.kumuluz.com/) 这个框架获得了
**2015 Java Duke's Choice Award Winner**
* Spring Cloud 对Netflex的微服务框架做了一些封装
* 。。。还有很多

最后，附上Martin Flower的警告：

> 除非你的系统太复杂，作为单体应用会很难管理，否则不要考虑微服务。绝大多数软件系统都应该构建为单体应用。要注重在单体应用中实现良好的模块化，但不要试图将其拆分成单独的服务。
